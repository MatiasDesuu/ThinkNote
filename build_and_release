#!/bin/bash

# Configure variables
GITEA_URL="http://192.168.1.119:10009"
REPO_OWNER="MatiasDesu"
REPO_NAME="ThinkNote"
GITEA_TOKEN="47dc8216649cd1d8f9b40174f3156bf75cdb7600"
# Replace with your Gitea token
APK_PATH="$PWD/build/app/outputs/flutter-apk/app-release.apk"
RELEASE_TAG="v1.0.0-$(date +%Y%m%d-%H%M%S)"
RELEASE_NAME="Release $RELEASE_TAG"
RELEASE_BODY="Automatic release from build script"

android_build() {
    # Execute the build for Android
    echo "Building APK..."
    flutter build apk --release

    if [ $? -ne 0 ]; then
        echo "Build failed!"
        exit 1
    fi

    echo "Build successful. APK created at $APK_PATH"

    # Create a release on Gitea
    echo "Creating release on Gitea..."
    curl --fail -X POST "$GITEA_URL/api/v1/repos/$REPO_OWNER/$REPO_NAME/releases?token=$GITEA_TOKEN" -H "Content-Type: application/json" -d "{\"tag_name\":\"$RELEASE_TAG\",\"name\":\"$RELEASE_NAME\",\"body\":\"$RELEASE_BODY\"}" -o release_response.json
    if [ $? -ne 0 ]; then
        echo "Failed to create release! Response:"
        cat release_response.json
        exit 1
    fi

    # Obtain the upload URL from the response
    UPLOAD_URL=$(jq -r '.upload_url' release_response.json | sed 's/{.*}//')
    if [ -z "$UPLOAD_URL" ]; then
        echo "Failed to get upload URL! Response:"
        cat release_response.json
        exit 1
    fi

    echo "Release created. Upload URL: $UPLOAD_URL"

    # Upload the APK
    echo "Uploading APK..."
    curl --fail -s -X POST "$UPLOAD_URL?name=app-release.apk&token=$GITEA_TOKEN" -F "attachment=@$APK_PATH" > /dev/null

    if [ $? -ne 0 ]; then
        echo "Failed to upload APK!"
        exit 1
    fi

    echo "APK uploaded successfully."
}

windows_build() {
    # Execute the build for Windows
    echo "Building Windows executable..."
    flutter build windows

    if [ $? -ne 0 ]; then
        echo "Build failed!"
        exit 1
    fi

    echo "Build successful. Copying to destination..."
    DEST_DIR="E:\Programas (descargados)\ThinkSoftware\ThinkNote"
    mkdir -p "$DEST_DIR"
    cp -r "$PWD/build/windows/x64/runner/Release/*" "$DEST_DIR"

    if [ $? -ne 0 ]; then
        echo "Failed to copy files!"
        exit 1
    fi

    echo "Files copied successfully to $DEST_DIR"
}

linux_build() {
    # Execute the build for Linux
    echo "Building Linux executable..."
    flutter build linux --release

    if [ $? -ne 0 ]; then
        echo "Build failed!"
        exit 1
    fi

    echo "Build successful. Copying to destination..."
    DEST_DIR="/home/matiasdesu/Documents/Software/ThinkNote"
    mkdir -p "$DEST_DIR"
    # Kill any running instance of the app
    pkill -f thinknote || true
    cp -r "$PWD/build/linux/x64/release/bundle/." "$DEST_DIR"

    if [ $? -ne 0 ]; then
        echo "Failed to copy files!"
        exit 1
    fi

    echo "Files copied successfully to $DEST_DIR"
}

# Select build platform
echo "Select the platform for the build:"
echo "1. Android (APK)"
echo "2. Windows"
echo "3. Linux"
read -p "Choose an option (1-3): " PLATFORM_CHOICE

if [ "$PLATFORM_CHOICE" == "1" ]; then
    android_build
elif [ "$PLATFORM_CHOICE" == "2" ]; then
    windows_build
elif [ "$PLATFORM_CHOICE" == "3" ]; then
    linux_build
else
    echo "Invalid option. Exiting..."
    exit 1
fi

echo "Script completed successfully!"